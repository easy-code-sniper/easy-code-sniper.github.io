<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>react-use源码阅读 | easycodesniper | blog by chen qiyi</title>

  
  <meta name="author" content="chen qiyi">
  

  
  <meta name="description" content="前言React的开发离不开hooks，在社区中也有各种的hooks工具库。本篇阅读的就是react-use工具库
希望通过阅读源码，加深自己对于React Hook的理解。
useCustomCompareEffectReact的useEffect比较依赖项的规则是Object.is()，它大部分情">
  

  
  
  <meta name="keywords" content="React Hooks">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="react-use源码阅读"/>

  <meta property="og:site_name" content="easycodesniper"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="easycodesniper" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">easycodesniper</a>
    </h1>
    <p class="site-description">blog by chen qiyi</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>react-use源码阅读</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/03/29/react-use源码阅读/" rel="bookmark">
        <time class="entry-date published" datetime="2024-03-29T13:07:05.000Z">
          2024-03-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>React的开发离不开hooks，在社区中也有各种的hooks工具库。本篇阅读的就是<a target="_blank" rel="noopener" href="https://github.com/streamich/react-use">react-use</a>工具库</p>
<p>希望通过阅读源码，加深自己对于React Hook的理解。</p>
<h2 id="useCustomCompareEffect"><a href="#useCustomCompareEffect" class="headerlink" title="useCustomCompareEffect"></a>useCustomCompareEffect</h2><p>React的<code>useEffect</code>比较依赖项的规则是<code>Object.is()</code>，它大部分情况下和<code>===</code>的效果是相同的<br><code>useCustomCompareEffect</code>Hook 用于当依赖项是对象或者数组时自定义依赖项比较方法，定义更加复杂的比较逻辑</p>
<p>使用示例:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> useCustomCompareEffect <span class="keyword">from</span> <span class="string">&quot;./hooks/useCustomCompareEffect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [obj, setObj] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;kyrie&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">21</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 自定义比较函数，只有当name值发生变化是重新渲染</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">depsEqual</span> = (<span class="params">newDeps, prevDeps</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (prevDeps[<span class="number">0</span>]?.<span class="property">name</span> === newDeps[<span class="number">0</span>]?.<span class="property">name</span>) ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useCustomCompareEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🚀~~ useCustomCompareEffect working !&#x27;</span>);</span><br><span class="line">  &#125;, depsEqual, [obj])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>name: &#123; obj.name &#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>age: &#123; obj.age &#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setObj(&#123; ...obj, name: &#x27;easy code sniper&#x27; &#125;)&#125;&gt;修改name<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setObj(&#123; ...obj, age: 30 &#125;)&#125;&gt;修改age<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></table></figure>

<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DependencyList</span>, <span class="title class_">EffectCallback</span>, useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是基本类型值，是基本类型就返回true</span></span><br><span class="line"><span class="comment">// Object()：给Object()函数传递一个值，如果是对象或者数组，则返回该值的引用；如果是基本类型值，则把该基本类型值包装成为对应的对象类型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isPrimitive</span> = (<span class="params">val: any</span>) =&gt; val !== <span class="title class_">Object</span>(val);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义比较函数有两个参数：旧的deps 和 新的deps ，该函数需要返回一个bool值来表示依赖是否发生变化</span></span><br><span class="line">type <span class="title class_">DepsEqualFnType</span>&lt;<span class="title class_">TDeps</span> <span class="keyword">extends</span> <span class="title class_">DependencyList</span>&gt; = <span class="function">(<span class="params">prevDeps: TDeps, nextDeps: TDeps</span>) =&gt;</span> boolean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接受三个参数</span></span><br><span class="line"><span class="comment"> * effect：副作用函数</span></span><br><span class="line"><span class="comment"> * deps：依赖项</span></span><br><span class="line"><span class="comment"> * depsEqual：自定义比较函数，该函数有两个参数，前一个依赖项 和 当前依赖项，要求返回一个boolean来表示依赖项是否发生了变化</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> useCustomCompareEffect = &lt;<span class="title class_">TDeps</span> <span class="keyword">extends</span> <span class="title class_">DependencyList</span>&gt;<span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  effect: EffectCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">  deps: TDeps,</span></span></span><br><span class="line"><span class="params"><span class="function">  depsEqual: DepsEqualFnType&lt;TDeps&gt;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 生产环境下的一些警告提示，可以忽略</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// deps依赖必须有</span></span><br><span class="line">    <span class="keyword">if</span> (!(deps <span class="keyword">instanceof</span> <span class="title class_">Array</span>) || !deps.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;`useCustomCompareEffect` should not be used with no dependencies. Use React.useEffect instead.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果每一项依赖都是基本类型，那使用useEffect即可</span></span><br><span class="line">    <span class="keyword">if</span> (deps.<span class="title function_">every</span>(isPrimitive)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;`useCustomCompareEffect` should not be used with dependencies that are all primitive values. Use React.useEffect instead.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// depsEqual 必须是一个函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> depsEqual !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;`useCustomCompareEffect` should be used with depsEqual callback for comparing deps list&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//定义一个ref来存储依赖项</span></span><br><span class="line">  <span class="keyword">const</span> ref = useRef&lt;<span class="title class_">TDeps</span> | <span class="literal">undefined</span>&gt;(<span class="literal">undefined</span>); </span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  *  !ref.current 表示初次渲染</span></span><br><span class="line"><span class="comment">  *  !depsEqual(deps, ref.current) 根据自定义的比较函数来判断依赖是否发生变化</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!ref.<span class="property">current</span> || !<span class="title function_">depsEqual</span>(deps, ref.<span class="property">current</span>)) &#123; </span><br><span class="line">    ref.<span class="property">current</span> = deps; <span class="comment">// 当初次渲染时，或者依赖项发生变化时，ref存储新的依赖</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useEffect依赖的并不是deps，实际依赖的是ref.current </span></span><br><span class="line">  <span class="comment">// 只有在depsEqual函数判断依赖项发生了变化，并更新ref.current之后，useEffect才会重新执行effect</span></span><br><span class="line">  <span class="title function_">useEffect</span>(effect, ref.<span class="property">current</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useCustomCompareEffect;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="useShallowCompareEffect"><a href="#useShallowCompareEffect" class="headerlink" title="useShallowCompareEffect"></a>useShallowCompareEffect</h2><p>React的<code>useEffect</code>比较依赖项的规则是<code>Object.is()</code>，它大部分情况下和<code>===</code>的效果是相同的<br><code>useShallowCompareEffect</code>Hook 会对每个依赖项进行浅比较，而不是引用相等</p>
<blockquote>
<p>浅比较<br>通常是检查对象的顶层属性是否具有相同的值和相同的引用，对于嵌套对象不进行深入比较</p>
</blockquote>
<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DependencyList</span>, <span class="title class_">EffectCallback</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; equal <span class="keyword">as</span> isShallowEqual &#125; <span class="keyword">from</span> <span class="string">&#x27;fast-shallow-equal&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> useCustomCompareEffect <span class="keyword">from</span> <span class="string">&#x27;./useCustomCompareEffect&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是基本类型值</span></span><br><span class="line"><span class="comment">// 给Object()函数传递一个值，如果是对象或者数组，则返回该值的引用；如果是基本类型值，则把该基本类型值包装成为对应的对象类型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isPrimitive</span> = (<span class="params">val: any</span>) =&gt; val !== <span class="title class_">Object</span>(val);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用第三方库，实现依赖项的浅比较</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">shallowEqualDepsList</span> = (<span class="params">prevDeps: DependencyList, nextDeps: DependencyList</span>) =&gt;</span><br><span class="line">  prevDeps.<span class="title function_">every</span>(<span class="function">(<span class="params">dep, index</span>) =&gt;</span> <span class="title function_">isShallowEqual</span>(dep, nextDeps[index]));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接受两个参数</span></span><br><span class="line"><span class="comment"> * effect：副作用函数</span></span><br><span class="line"><span class="comment"> * deps：依赖项</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useShallowCompareEffect</span> = (<span class="params">effect: EffectCallback, deps: DependencyList</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 生产环境下的一些警告提示，可以忽略</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(deps <span class="keyword">instanceof</span> <span class="title class_">Array</span>) || !deps.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;`useShallowCompareEffect` should not be used with no dependencies. Use React.useEffect instead.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deps.<span class="title function_">every</span>(isPrimitive)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;`useShallowCompareEffect` should not be used with dependencies that are all primitive values. Use React.useEffect instead.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调用 useCustomCompareEffect , 将shallowEqualDepsList作为自定义比较方法</span></span><br><span class="line">  <span class="comment">// 实际上就是对 useCustomCompareEffect 的又一层封装</span></span><br><span class="line">  <span class="title function_">useCustomCompareEffect</span>(effect, deps, shallowEqualDepsList);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useShallowCompareEffect;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="useEvent"><a href="#useEvent" class="headerlink" title="useEvent"></a>useEvent</h2><p>用于在特定的事件目标（如 window、document 或任何实现了特定事件监听器接口的对象）上添加和移除事件监听器，它旨在 在不同类型的事件目标上 提供一个统一的 API</p>
<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="comment">// isBrower 判断是否是浏览器环境</span></span><br><span class="line"><span class="comment">// on off 是封装好的浏览器事件监听器添加和移除方法</span></span><br><span class="line"><span class="keyword">import</span> &#123; isBrowser, off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ListenerType1 和 ListenerType2 接口定义了两种不同的事件监听模式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">ListenerType1</span> &#123;</span><br><span class="line">  <span class="title function_">addEventListener</span>(<span class="attr">name</span>: string, <span class="attr">handler</span>: <span class="function">(<span class="params">event?: any</span>) =&gt;</span> <span class="keyword">void</span>, ...<span class="attr">args</span>: any[]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">removeEventListener</span>(<span class="attr">name</span>: string, <span class="attr">handler</span>: <span class="function">(<span class="params">event?: any</span>) =&gt;</span> <span class="keyword">void</span>, ...<span class="attr">args</span>: any[]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">ListenerType2</span> &#123;</span><br><span class="line">  <span class="title function_">on</span>(<span class="attr">name</span>: string, <span class="attr">handler</span>: <span class="function">(<span class="params">event?: any</span>) =&gt;</span> <span class="keyword">void</span>, ...<span class="attr">args</span>: any[]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">off</span>(<span class="attr">name</span>: string, <span class="attr">handler</span>: <span class="function">(<span class="params">event?: any</span>) =&gt;</span> <span class="keyword">void</span>, ...<span class="attr">args</span>: any[]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">UseEventTarget</span> = <span class="title class_">ListenerType1</span> | <span class="title class_">ListenerType2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// isListenerType1 和 isListenerType2 用来判断目标事件对象是否有 addEventListener 或 on 属性来实现的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isListenerType1 = (<span class="attr">target</span>: any): target is <span class="title class_">ListenerType1</span> =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> !!target.<span class="property">addEventListener</span>; <span class="comment">// !! 任何真值都会被转化成true，假值都会被转化成false</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> isListenerType2 = (<span class="attr">target</span>: any): target is <span class="title class_">ListenerType2</span> =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> !!target.<span class="property">on</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultTarget = isBrowser ? <span class="variable language_">window</span> : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接受四个参数；</span></span><br><span class="line"><span class="comment"> * name：事件名称</span></span><br><span class="line"><span class="comment"> * handler：事件处理函数</span></span><br><span class="line"><span class="comment"> * target：事件监听器的目标对象，默认值是 defaultTarget</span></span><br><span class="line"><span class="comment"> * options：可选参数，用于传递给事件监听器的选项</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useEvent</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  name,</span></span><br><span class="line"><span class="params">  handler,</span></span><br><span class="line"><span class="params">  target,</span></span><br><span class="line"><span class="params">  options?</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!handler || !target) &#123; <span class="comment">// 如果没有传入事件处理函数或者事件对象，不做任何处理直接返回</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isListenerType1</span>(target)) &#123; <span class="comment">//如果目标对象实现的是addEventListener模式，将它手动代理成on模式来添加监听器</span></span><br><span class="line">      <span class="title function_">on</span>(target, name, handler, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isListenerType2</span>(target)) &#123; <span class="comment">//如果目标对象实现的是on模式，直接用on模式添加监听器</span></span><br><span class="line">      target.<span class="title function_">on</span>(name, handler, options);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123; <span class="comment">// 在组件销毁时删除事件监听</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isListenerType1</span>(target)) &#123;</span><br><span class="line">        <span class="title function_">off</span>(target, name, handler, options);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isListenerType2</span>(target)) &#123;</span><br><span class="line">        target.<span class="title function_">off</span>(name, handler, options);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [name, handler, target, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(options)]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useEvent;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>on</code> 和 <code>off</code>函数的封装：</p>
<p>on函数接受一个可能为null的对象obj和一个参数列表args。参数列表可以是任何addEventListener方法接受的参数。函数内部会检查obj是否存在并且是否有addEventListener方法。如果条件满足，它会调用obj.addEventListener并传入args参数。<br>这个函数的主要作用是检查对象是否存在并且可以添加事件监听器，然后按照给定的参数调用addEventListener方法。这样做可以避免直接在组件内部调用addEventListener时可能遇到的null或undefined对象错误。</p>
<p>off函数同理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> on&lt;T <span class="keyword">extends</span> <span class="title class_">Window</span> | <span class="title class_">Document</span> | <span class="title class_">HTMLElement</span> | <span class="title class_">EventTarget</span>&gt;(</span><br><span class="line">  <span class="attr">obj</span>: T | <span class="literal">null</span>,</span><br><span class="line">  ...<span class="attr">args</span>: <span class="title class_">Parameters</span>&lt;T[<span class="string">&#x27;addEventListener&#x27;</span>]&gt; | [string, <span class="title class_">Function</span> | <span class="literal">null</span>, ...any]</span><br><span class="line">): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj &amp;&amp; obj.<span class="property">addEventListener</span>) &#123;</span><br><span class="line">    obj.<span class="title function_">addEventListener</span>(...(args <span class="keyword">as</span> <span class="title class_">Parameters</span>&lt;<span class="title class_">HTMLElement</span>[<span class="string">&#x27;addEventListener&#x27;</span>]&gt;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> off&lt;T <span class="keyword">extends</span> <span class="title class_">Window</span> | <span class="title class_">Document</span> | <span class="title class_">HTMLElement</span> | <span class="title class_">EventTarget</span>&gt;(</span><br><span class="line">  <span class="attr">obj</span>: T | <span class="literal">null</span>,</span><br><span class="line">  ...<span class="attr">args</span>: <span class="title class_">Parameters</span>&lt;T[<span class="string">&#x27;removeEventListener&#x27;</span>]&gt; | [string, <span class="title class_">Function</span> | <span class="literal">null</span>, ...any]</span><br><span class="line">): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj &amp;&amp; obj.<span class="property">removeEventListener</span>) &#123;</span><br><span class="line">    obj.<span class="title function_">removeEventListener</span>(...(args <span class="keyword">as</span> <span class="title class_">Parameters</span>&lt;<span class="title class_">HTMLElement</span>[<span class="string">&#x27;removeEventListener&#x27;</span>]&gt;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useGeolocation"><a href="#useGeolocation" class="headerlink" title="useGeolocation"></a>useGeolocation</h2><p>该hook用于获取和追逐用户的地理位置，基于浏览器内置对象<code>navigator</code>实现</p>
<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义获取位置错误的接口</span></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">IGeolocationPositionError</span> &#123; </span><br><span class="line">  readonly <span class="attr">code</span>: number;</span><br><span class="line">  readonly <span class="attr">message</span>: string;</span><br><span class="line">  readonly <span class="attr">PERMISSION_DENIED</span>: number;</span><br><span class="line">  readonly <span class="attr">POSITION_UNAVAILABLE</span>: number;</span><br><span class="line">  readonly <span class="attr">TIMEOUT</span>: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义当前位置信息的接口</span></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">GeoLocationSensorState</span> &#123; </span><br><span class="line">  <span class="attr">loading</span>: boolean; <span class="comment">//位置信息是否正在加载中</span></span><br><span class="line">  <span class="attr">accuracy</span>: number | <span class="literal">null</span>; <span class="comment">//获取的位置的精确度</span></span><br><span class="line">  <span class="attr">altitude</span>: number | <span class="literal">null</span>;  <span class="comment">//相对于海平面的高度</span></span><br><span class="line">  <span class="attr">altitudeAccuracy</span>: number | <span class="literal">null</span>; <span class="comment">//高度的精确度</span></span><br><span class="line">  <span class="attr">heading</span>: number | <span class="literal">null</span>; <span class="comment">//设备移动方向</span></span><br><span class="line">  <span class="attr">latitude</span>: number | <span class="literal">null</span>; <span class="comment">//纬度</span></span><br><span class="line">  <span class="attr">longitude</span>: number | <span class="literal">null</span>; <span class="comment">//经度</span></span><br><span class="line">  <span class="attr">speed</span>: number | <span class="literal">null</span>; <span class="comment">//速度</span></span><br><span class="line">  <span class="attr">timestamp</span>: number | <span class="literal">null</span>; <span class="comment">//这些位置数据的时间戳</span></span><br><span class="line">  error?: <span class="title class_">Error</span> | <span class="title class_">IGeolocationPositionError</span>; <span class="comment">//在获取地理位置信息时发生错误，这里会存储错误信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">PositionOptions</span> &#123;</span><br><span class="line">    enableHighAccuracy?: boolean; <span class="comment">// 是否需要高精度的位置信息</span></span><br><span class="line">    maximumAge?: number; <span class="comment">// 能接受多旧的位置信息</span></span><br><span class="line">    timeout?: number; <span class="comment">//获取位置信息的最长等待时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useGeolocation = (options?: <span class="title class_">PositionOptions</span>): <span class="function"><span class="params">GeoLocationSensorState</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState&lt;<span class="title class_">GeoLocationSensorState</span>&gt;(&#123;</span><br><span class="line">    <span class="attr">loading</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">accuracy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">altitude</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">altitudeAccuracy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">heading</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">latitude</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">longitude</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">speed</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">let</span> mounted = <span class="literal">true</span>; <span class="comment">// 表示组件是否挂载</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">watchId</span>: any; <span class="comment">// 调用navigator.geolocation.watchPosition返回的id，用于在组件卸载时清除监听</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置信息请求成功的回调函数，navigator.geolocation.getCurrentPosition会在成功时传给该函数一个Positon对象，包含了位置信息</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onEvent</span> = (<span class="params">event: any</span>) =&gt; &#123; </span><br><span class="line">    <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">      <span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">accuracy</span>: event.<span class="property">coords</span>.<span class="property">accuracy</span>,</span><br><span class="line">        <span class="attr">altitude</span>: event.<span class="property">coords</span>.<span class="property">altitude</span>,</span><br><span class="line">        <span class="attr">altitudeAccuracy</span>: event.<span class="property">coords</span>.<span class="property">altitudeAccuracy</span>,</span><br><span class="line">        <span class="attr">heading</span>: event.<span class="property">coords</span>.<span class="property">heading</span>,</span><br><span class="line">        <span class="attr">latitude</span>: event.<span class="property">coords</span>.<span class="property">latitude</span>,</span><br><span class="line">        <span class="attr">longitude</span>: event.<span class="property">coords</span>.<span class="property">longitude</span>,</span><br><span class="line">        <span class="attr">speed</span>: event.<span class="property">coords</span>.<span class="property">speed</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: event.<span class="property">timestamp</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置信息请求失败的回调函数，navigator.geolocation.getCurrentPosition会在失败时传给该函数一个error对象，包含了错误信息</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onEventError</span> = (<span class="params">error: IGeolocationPositionError</span>) =&gt;</span><br><span class="line">    mounted &amp;&amp; <span class="title function_">setState</span>(<span class="function">(<span class="params">oldState</span>) =&gt;</span> (&#123; ...oldState, <span class="attr">loading</span>: <span class="literal">false</span>, error &#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * navigator.geolocation.getCurrentPosition用于获取当前地理位置信息</span></span><br><span class="line"><span class="comment">   * 接受三个参数：成功的回调、错误时的回调（可选）、选项对象PositionOptions（可选）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * navigator.geolocation.watchPosition用于注册一个监听器，在用户的设备地理位置发生变化时被调用。该方法返回一个id，用于取消监听</span></span><br><span class="line"><span class="comment">   * 接受三个参数：成功的回调、错误时的回调（可选）、选项对象PositionOptions（可选）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * navigator.geolocation.clearWatch(watchId)用于取消监听，传入监听器id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    navigator.<span class="property">geolocation</span>.<span class="title function_">getCurrentPosition</span>(onEvent, onEventError, options);</span><br><span class="line">    watchId = navigator.<span class="property">geolocation</span>.<span class="title function_">watchPosition</span>(onEvent, onEventError, options);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      mounted = <span class="literal">false</span>;</span><br><span class="line">      navigator.<span class="property">geolocation</span>.<span class="title function_">clearWatch</span>(watchId);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useGeolocation;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>navigator对象 是 浏览器内置对象，它提供了关于用户浏览器的信息</p>
</blockquote>
<img src="/2024/03/29/react-use%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image-1.png" class title="This is an image">

<h2 id="useHover"><a href="#useHover" class="headerlink" title="useHover"></a>useHover</h2><p><code>useHover</code>提供一种简单的方式来跟踪鼠标悬停状态。这个钩子接受一个 React 元素或者一个返回 React 元素的函数，并返回一个数组，包含一个带有悬停事件处理的克隆元素以及一个表示悬停状态（true 或 false）的布尔值。</p>
<p><strong>使用示例：</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> useHover <span class="keyword">from</span> <span class="string">&#x27;./useHover&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MyComponent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [hoverableElement, isHovered] = <span class="title function_">useHover</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hover over me!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;hoverableElement&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;isHovered &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>You are hovering!<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// noop 不执行任何操作的空函数 () =&gt; &#123;&#125;</span></span><br><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; useState &#125; = <span class="title class_">React</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义Element接口，表示Element类型可以是一个React元素，也可以是一个函数，该函数接受一个boolean类型的参数，并返回React元素</span></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">Element</span> = (<span class="function">(<span class="params">state: boolean</span>) =&gt;</span> <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;any&gt;) | <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;any&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useHover 接受一个Element类型的参数</span></span><br><span class="line"><span class="keyword">const</span> useHover = (<span class="attr">element</span>: <span class="title class_">Element</span>): [<span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;any&gt;, boolean] =&gt; &#123;</span><br><span class="line">  <span class="comment">// state状态用于表示是否处于鼠标悬停状态</span></span><br><span class="line">  <span class="keyword">const</span> [state, setState] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 接受一个原始事件处理函数，返回一个新的事件处理函数。</span></span><br><span class="line">  <span class="comment">// 新的事件处理函数首先调用传入的原始事件处理函数（如果没有提供，则调用 noop），然后通过 setState 更新悬停状态。</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onMouseEnter</span> = (<span class="params">originalOnMouseEnter?: any</span>) =&gt; <span class="function">(<span class="params">event: any</span>) =&gt;</span> &#123;</span><br><span class="line">    (originalOnMouseEnter || noop)(event);</span><br><span class="line">    <span class="title function_">setState</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onMouseLeave</span> = (<span class="params">originalOnMouseLeave?: any</span>) =&gt; <span class="function">(<span class="params">event: any</span>) =&gt;</span> &#123;</span><br><span class="line">    (originalOnMouseLeave || noop)(event);</span><br><span class="line">    <span class="title function_">setState</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 传入的element是一个函数，则将代表是否hover的状态state传入来返回对应的React元素</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> element === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    element = <span class="title function_">element</span>(state);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// element.props.onMouseEnter 和 element.props.onMouseLeave 是原始元素上可能存在的鼠标悬停和离开函数</span></span><br><span class="line">  <span class="keyword">const</span> el = <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(element, &#123;</span><br><span class="line">    <span class="attr">onMouseEnter</span>: <span class="title function_">onMouseEnter</span>(element.<span class="property">props</span>.<span class="property">onMouseEnter</span>),</span><br><span class="line">    <span class="attr">onMouseLeave</span>: <span class="title function_">onMouseLeave</span>(element.<span class="property">props</span>.<span class="property">onMouseLeave</span>),</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回克隆的React元素 以及 表示悬浮状态的state</span></span><br><span class="line">  <span class="keyword">return</span> [el, state];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useHover;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>React.cloneElement()</code></strong></p>
<p>它允许你克隆一个React元素，并且可以选择性的传入props、子元素以及key。它的作用是基于已有的React元素创建一个新的元素，默认保留原有元素的props、内部状态和行为</p>
<blockquote>
<p>默认保留原有元素的props、内部状态和行为<br>因为在默认情况下，React只是浅克隆了原有元素，并传入新的props。在不改变key的情况下，React会视这两个组件为同一个实例，这就意味着，即使属性可能有所改变，但由于组件类型和 key 没有变化，React的重用逻辑会保留组件实例及其内部状态。</p>
</blockquote>
<p>使用<code>React.cloneElement</code>可以很方便地扩展或修改组件的子元素，而不需要创建一个全新的组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">cloneElement</span>(</span><br><span class="line">  element, <span class="comment">// 想要克隆的React对象</span></span><br><span class="line">  props, <span class="comment">// 可选参数。传入一个对象，包含要添加或者覆盖的新属性</span></span><br><span class="line">  [...children] <span class="comment">// 可选参数。可以传入任意数量的子节点来替换被克隆元素的子节点</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>React.cloneElement</code> 使用示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ListItem</span> = (<span class="params">&#123; children, onClick &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">List</span> = (<span class="params">&#123; items &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;items.map((item, index) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        // 克隆ListItem，并为每个item添加特定的onClick处理器</span></span><br><span class="line"><span class="language-xml">        return React.cloneElement(<span class="tag">&lt;<span class="name">ListItem</span>&gt;</span>&#123;item.text&#125;<span class="tag">&lt;/<span class="name">ListItem</span>&gt;</span>, &#123;</span></span><br><span class="line"><span class="language-xml">          key: index, // 必须提供key，特别是在map循环中</span></span><br><span class="line"><span class="language-xml">          onClick: () =&gt; alert(`Item $&#123;index + 1&#125; clicked!`), // 绑定了一个弹窗事件</span></span><br><span class="line"><span class="language-xml">        &#125;);</span></span><br><span class="line"><span class="language-xml">      &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用List组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> items = [</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&#x27;Item 1&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&#x27;Item 2&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">&#x27;Item 3&#x27;</span> &#125;,</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">List</span> <span class="attr">items</span>=<span class="string">&#123;items&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></table></figure>

<h2 id="useHoverDirty"><a href="#useHoverDirty" class="headerlink" title="useHoverDirty"></a>useHoverDirty</h2><p><code>useHoverDirty</code>提供一种方式来检测用户是否悬浮在某个元素上</p>
<p><code>useHover</code>接受一个React元素或者一个函数，而<code>useHoverDirty</code>接受<code>React ref</code><br><code>useHover</code>通过设置React元素的<code>onMouseOver</code>和<code>onMouseOut</code>事件，而<code>useHoverDirty</code>通过设置DOM元素的<code>onMouseOver</code>和<code>onMouseOut</code>事件</p>
<p><strong>使用示例：</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> useHoverDirty <span class="keyword">from</span> <span class="string">&#x27;./useHoverDirty&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">HoverComponent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 创建一个ref来引用我们想要检测悬停的DOM元素</span></span><br><span class="line">  <span class="keyword">const</span> hoverRef = <span class="title function_">useRef</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// 使用我们的自定义Hook来获取悬停状态</span></span><br><span class="line">  <span class="keyword">const</span> isHovered = <span class="title function_">useHoverDirty</span>(hoverRef);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据悬停状态动态设置样式</span></span><br><span class="line">  <span class="keyword">const</span> style = &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="string">&#x27;200px&#x27;</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="string">&#x27;200px&#x27;</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: isHovered ? <span class="string">&#x27;blue&#x27;</span> : <span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">    <span class="comment">// 当鼠标悬停时背景色变蓝，否则为红色</span></span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">    <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">transition</span>: <span class="string">&#x27;background-color 0.3s&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;hoverRef&#125;</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isHovered ? &#x27;Hovering&#x27; : &#x27;Not Hovering&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">HoverComponent</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RefObject</span>, useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ref: 这是一个React ref对象，指向要监听悬浮事件的DOM元素。使用ref是因为我们需要直接操作DOM元素来绑定和解绑事件监听器。</span></span><br><span class="line"><span class="comment"> * enabled: 这是一个可选参数，默认为true。它允许使用者启用或禁用悬浮监听功能。这可以用来在某些条件下动态开启或关闭事件监听。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useHoverDirty</span> = (<span class="params">ref: RefObject&lt;Element&gt;, enabled: boolean = <span class="literal">true</span></span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发模式下的警告，可以忽略</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> ref !== <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> ref.<span class="property">current</span> === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;useHoverDirty expects a single ref argument.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否处于悬浮状态的state</span></span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onMouseOver</span> = (<span class="params"></span>) =&gt; <span class="title function_">setValue</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onMouseOut</span> = (<span class="params"></span>) =&gt; <span class="title function_">setValue</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enabled &amp;&amp; ref &amp;&amp; ref.<span class="property">current</span>) &#123;</span><br><span class="line">      <span class="title function_">on</span>(ref.<span class="property">current</span>, <span class="string">&#x27;mouseover&#x27;</span>, onMouseOver);</span><br><span class="line">      <span class="title function_">on</span>(ref.<span class="property">current</span>, <span class="string">&#x27;mouseout&#x27;</span>, onMouseOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; current &#125; = ref;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enabled &amp;&amp; current) &#123;</span><br><span class="line">        <span class="title function_">off</span>(current, <span class="string">&#x27;mouseover&#x27;</span>, onMouseOver);</span><br><span class="line">        <span class="title function_">off</span>(current, <span class="string">&#x27;mouseout&#x27;</span>, onMouseOut);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [enabled, ref]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useHoverDirty;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// on函数 和 off函数 的封装</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> on&lt;T <span class="keyword">extends</span> <span class="title class_">Window</span> | <span class="title class_">Document</span> | <span class="title class_">HTMLElement</span> | <span class="title class_">EventTarget</span>&gt;(</span><br><span class="line">  <span class="attr">obj</span>: T | <span class="literal">null</span>,</span><br><span class="line">  ...<span class="attr">args</span>: <span class="title class_">Parameters</span>&lt;T[<span class="string">&#x27;addEventListener&#x27;</span>]&gt; | [string, <span class="title class_">Function</span> | <span class="literal">null</span>, ...any]</span><br><span class="line">): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj &amp;&amp; obj.<span class="property">addEventListener</span>) &#123;</span><br><span class="line">    obj.<span class="title function_">addEventListener</span>(...(args <span class="keyword">as</span> <span class="title class_">Parameters</span>&lt;<span class="title class_">HTMLElement</span>[<span class="string">&#x27;addEventListener&#x27;</span>]&gt;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> off&lt;T <span class="keyword">extends</span> <span class="title class_">Window</span> | <span class="title class_">Document</span> | <span class="title class_">HTMLElement</span> | <span class="title class_">EventTarget</span>&gt;(</span><br><span class="line">  <span class="attr">obj</span>: T | <span class="literal">null</span>,</span><br><span class="line">  ...<span class="attr">args</span>: <span class="title class_">Parameters</span>&lt;T[<span class="string">&#x27;removeEventListener&#x27;</span>]&gt; | [string, <span class="title class_">Function</span> | <span class="literal">null</span>, ...any]</span><br><span class="line">): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj &amp;&amp; obj.<span class="property">removeEventListener</span>) &#123;</span><br><span class="line">    obj.<span class="title function_">removeEventListener</span>(...(args <span class="keyword">as</span> <span class="title class_">Parameters</span>&lt;<span class="title class_">HTMLElement</span>[<span class="string">&#x27;removeEventListener&#x27;</span>]&gt;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="useIntersection"><a href="#useIntersection" class="headerlink" title="useIntersection"></a>useIntersection</h2><p><code>useIntersection</code>使用了浏览器的 Intersection Observer API 来异步地检测目标元素与其祖先元素或顶级文档视口的交叉状态的变化。</p>
<blockquote>
<p>Intersection Observer API 是一个浏览器API，它允许你异步观察一个元素与其祖先元素或全局视口的交集变化。能够高效得获取元素是否进入或离开视口的信息。</p>
</blockquote>
<p><strong>相关概念</strong></p>
<ul>
<li><code>root（根）</code>: 想要检查目标元素与之相交的容器元素，如果未指定或为null，默认为浏览器视口</li>
<li><code>rootMargin（根边界）</code>: 类似于CSS的margin属性。它允许你指定一个在根元素的外围形成的边框区域，用于增加或减少用于检查交集的区域大小</li>
<li><code>threshold（阈值）</code>: 一个数字或由多个数字组成的数组，指定了观察者的回调函数被执行的条件。例如，如果阈值是0.5，则目标元素有50%进入根元素时，观察者的回调函数将被执行</li>
</ul>
<p><strong><code>IntersectionObserver()</code>方法</strong>是一个构造函数，用于创建一个新的 IntersectionObserver 对象。<br>这个构造函数接受两个参数：一个回调函数和一个可选的配置对象。</p>
<ul>
<li>回调函数：当被观察的元素进入或退出交集区域时，回调函数会被执行。这个函数接受两个参数：</li>
</ul>
<ul>
<li><code>entries</code>: 一个 IntersectionObserverEntry 对象数组，每个对象都描述了一个被观察元素的交集状态</li>
<li><code>observer</code>: 对应的 IntersectionObserver 实例，允许你访问观察者的属性或调用其方法，如 disconnect 或 unobserve</li>
</ul>
<ul>
<li>配置对象：包含三个属性</li>
</ul>
<ul>
<li>root</li>
<li>rootMargin</li>
<li>threshold</li>
</ul>
<p><strong>Intersection Observer</strong></p>
<ul>
<li><code>root</code>: 想要检查目标元素与之相交的容器元素，如果未指定或为null，默认为浏览器视口</li>
<li><code>rootMargin</code>: 类似于CSS的margin属性。它允许你指定一个在根元素的外围形成的边框区域，用于增加或减少用于检查交集的区域大小</li>
<li><code>thresholds</code>: 一个数字或由多个数字组成的数组，指定了观察者的回调函数被执行的条件。例如，如果阈值是0.5，则目标元素有50%进入根元素时，观察者的回调函数将被执行</li>
<li><code>disconnect()</code>: 停止观察所有目标</li>
<li><code>observe(target)</code>: 开始观察一个目标元素</li>
<li><code>takeRecords</code>: 返回所有目标的<code>IntersectionObserverEntry</code>对象数组</li>
<li><code>unobserve(targrt)</code>: 停止观察一个目标元素</li>
</ul>
<p><strong>Intersection Observer Entry</strong></p>
<ul>
<li><code>boundingClientRect</code>: 返回目标元素的矩形信息，用于计算与视口的交集</li>
<li><code>intersectionRatio</code>: 目标元素<strong>可见部分</strong>占总体的比例</li>
<li><code>intersectionRect</code>: 目标元素与视口<strong>交叉部分</strong>的矩形信息</li>
<li><code>isIntersecting</code>: 目标元素是否与根元素相交</li>
<li><code>rootBounds</code>: 根元素的矩形信息</li>
<li><code>target</code>: 目标元素</li>
<li><code>time</code>: 观察到交叉状态变化时的时间戳</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>懒加载：当图片或其他资源进入视口时才加载它们，以此节省带宽和提高页面加载速度</li>
<li>无限滚动: 当用户滚动到页面底部时，自动加载更多内容</li>
</ul>
<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RefObject</span>, useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * useIntersection接受两个参数</span></span><br><span class="line"><span class="comment"> * ref： 一个ref引用对象，指向要观察的目标元素</span></span><br><span class="line"><span class="comment"> * options： 配置对象，用于初始化Intersection Observer的选项，比如 root、rootMargin 和 threshold</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> useIntersection = (</span><br><span class="line">  <span class="attr">ref</span>: <span class="title class_">RefObject</span>&lt;<span class="title class_">HTMLElement</span>&gt;,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">IntersectionObserverInit</span></span><br><span class="line">): <span class="title class_">IntersectionObserverEntry</span> | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 创建 intersectionObserverEntry 状态，用于存储 intersectionObserverEntry 对象信息</span></span><br><span class="line">  <span class="keyword">const</span> [intersectionObserverEntry, setIntersectionObserverEntry] =</span><br><span class="line">    useState&lt;<span class="title class_">IntersectionObserverEntry</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ref是否存在，浏览器是否支持IntersectionObserver</span></span><br><span class="line">    <span class="keyword">if</span> (ref.<span class="property">current</span> &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">IntersectionObserver</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// handle函数用于更新 intersectionObserverEntry 状态</span></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params">entries: IntersectionObserverEntry[]</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setIntersectionObserverEntry</span>(entries[<span class="number">0</span>]);</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建一个监听器对象</span></span><br><span class="line">      <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(handler, options);</span><br><span class="line">      <span class="comment">// 监听目标元素</span></span><br><span class="line">      observer.<span class="title function_">observe</span>(ref.<span class="property">current</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 组件销毁时取消监听，并清空 intersectionObserverEntry 状态</span></span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setIntersectionObserverEntry</span>(<span class="literal">null</span>);</span><br><span class="line">        observer.<span class="title function_">disconnect</span>();</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">  &#125;, [ref.<span class="property">current</span>, options.<span class="property">threshold</span>, options.<span class="property">root</span>, options.<span class="property">rootMargin</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> intersectionObserverEntry;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useIntersection;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用示例</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useIntersection &#125; <span class="keyword">from</span> <span class="string">&#x27;react-use&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Demo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> intersectionRef = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> intersection = <span class="title function_">useIntersection</span>(intersectionRef, &#123;</span><br><span class="line">    <span class="attr">root</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">rootMargin</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">1</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;intersectionRef&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;intersection &amp;&amp; intersection.intersectionRatio &lt; 1</span></span><br><span class="line"><span class="language-xml">        ? &#x27;Obscured&#x27;</span></span><br><span class="line"><span class="language-xml">        : &#x27;Fully in view&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="useKey"><a href="#useKey" class="headerlink" title="useKey"></a>useKey</h2><p><code>useKey</code>用于设置监听键盘事件</p>
<p>源码及解析如下；</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DependencyList</span>, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> useEvent, &#123; <span class="title class_">UseEventOptions</span>, <span class="title class_">UseEventTarget</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./useEvent&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">KeyPredicate</span> = <span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> boolean;</span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">KeyFilter</span> = <span class="literal">null</span> | <span class="literal">undefined</span> | string | (<span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> boolean);</span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">Handler</span> = <span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">UseKeyOptions</span>&lt;T <span class="keyword">extends</span> <span class="title class_">UseEventTarget</span>&gt; &#123;</span><br><span class="line">  event?: <span class="string">&#x27;keydown&#x27;</span> | <span class="string">&#x27;keypress&#x27;</span> | <span class="string">&#x27;keyup&#x27;</span>;</span><br><span class="line">  target?: T | <span class="literal">null</span>;</span><br><span class="line">  options?: <span class="title class_">UseEventOptions</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// createKeyPredicate接受一个参数keyFilter，该参数可以是一个判断函数（用于判断何时符合条件）、一个字符串（指定的keyboard） 或者 undefined/null</span></span><br><span class="line"><span class="comment">// 然后 createKeyPredicate 根据不同的参数来创建判断函数</span></span><br><span class="line"><span class="comment">// 如果传入的是函数，就返回这个函数</span></span><br><span class="line"><span class="comment">// 如果传入的是字符串（特定的keyboard），则将它包装成一个函数，当event.key === 字符串 时返回true，表示符合条件触发回调函数</span></span><br><span class="line"><span class="comment">// 如果传入的是undefined/null，则包装一个固定返回false的函数，表示不符合条件不触发回调函数</span></span><br><span class="line"><span class="keyword">const</span> createKeyPredicate = (<span class="attr">keyFilter</span>: <span class="title class_">KeyFilter</span>): <span class="function"><span class="params">KeyPredicate</span> =&gt;</span></span><br><span class="line">  <span class="keyword">typeof</span> keyFilter === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? keyFilter</span><br><span class="line">    : <span class="keyword">typeof</span> keyFilter === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">    ? <span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> event.<span class="property">key</span> === keyFilter</span><br><span class="line">    : keyFilter</span><br><span class="line">    ? <span class="function">() =&gt;</span> <span class="literal">true</span></span><br><span class="line">    : <span class="function">() =&gt;</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 指定触发回调的键</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 要触发的回调函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> opts 配置选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deps 依赖项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> useKey = &lt;T <span class="keyword">extends</span> <span class="title class_">UseEventTarget</span>&gt;<span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  key: KeyFilter,</span></span></span><br><span class="line"><span class="params"><span class="function">  fn: Handler = noop,</span></span></span><br><span class="line"><span class="params"><span class="function">  opts: UseKeyOptions&lt;T&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">  deps: DependencyList = [key]</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// event 指定是哪种键盘事件（keydown，keyup，keypress）</span></span><br><span class="line">  <span class="comment">// target 绑定事件的目标对象</span></span><br><span class="line">  <span class="comment">// options 传递给useEvent的配置项</span></span><br><span class="line">  <span class="keyword">const</span> &#123; event = <span class="string">&#x27;keydown&#x27;</span>, target, options &#125; = opts;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 包装后的回调函数</span></span><br><span class="line">  <span class="keyword">const</span> useMemoHandler = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 根据传入的key值创建一个判断函数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">predicate</span>: <span class="title class_">KeyPredicate</span> = <span class="title function_">createKeyPredicate</span>(key);</span><br><span class="line">    <span class="comment">// handlerEvent 是浏览器事件对象，当向监听器添加事件处理函数时，浏览器会自动传入事件对象作为参数</span></span><br><span class="line">    <span class="comment">// 我们可以通过event参数访问到事件的详细信息，如被按下的键是什么（event.key）</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">handler</span>: <span class="title class_">Handler</span> = <span class="function">(<span class="params">handlerEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 判断是否符合触发回调的条件</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">predicate</span>(handlerEvent)) &#123;</span><br><span class="line">        <span class="comment">// 如果符合，就执行用户传入的回调函数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fn</span>(handlerEvent);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">  &#125;, deps);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用useEvent来为目标对象绑定事件</span></span><br><span class="line">  <span class="title function_">useEvent</span>(event, useMemoHandler, target, options);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useKey;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="useLongPress"><a href="#useLongPress" class="headerlink" title="useLongPress"></a>useLongPress</h2><p><code>useLongPress</code>用于设置长按之后触发的回调</p>
<p>源码及解析如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useCallback, useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Options</span> &#123;</span><br><span class="line">  isPreventDefault?: boolean;</span><br><span class="line">  delay?: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isTouchEvent = (<span class="attr">ev</span>: <span class="title class_">Event</span>): ev is <span class="title class_">TouchEvent</span> =&gt; &#123;</span><br><span class="line">  <span class="comment">// 检查浏览器传入的事件对象中是否有touches属性，即是否触发了touches事件</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;touches&#x27;</span> <span class="keyword">in</span> ev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">preventDefault</span> = (<span class="params">ev: Event</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isTouchEvent</span>(ev)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当触摸点个数小于2个时，阻止默认事件</span></span><br><span class="line">  <span class="keyword">if</span> (ev.<span class="property">touches</span>.<span class="property">length</span> &lt; <span class="number">2</span> &amp;&amp; ev.<span class="property">preventDefault</span>) &#123;</span><br><span class="line">    ev.<span class="title function_">preventDefault</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback 长按之后的回调函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> options 配置项对象（可选），其中包括是否阻止默认事件，延迟时间等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useLongPress</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  callback: (e: TouchEvent | MouseEvent) =&gt; <span class="keyword">void</span>,</span></span><br><span class="line"><span class="params">  &#123; isPreventDefault = <span class="literal">true</span>, delay = <span class="number">300</span> &#125;: Options = &#123;&#125;</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 用于缓存 定时器id 和 目标对象</span></span><br><span class="line">  <span class="keyword">const</span> timeout = useRef&lt;<span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> <span class="built_in">setTimeout</span>&gt;&gt;();</span><br><span class="line">  <span class="keyword">const</span> target = useRef&lt;<span class="title class_">EventTarget</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装监听触摸事件的函数</span></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title function_">useCallback</span>(</span><br><span class="line">    <span class="function">(<span class="params">event: TouchEvent | MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 绑定触摸事件，并缓存目标对象</span></span><br><span class="line">      <span class="keyword">if</span> (isPreventDefault &amp;&amp; event.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="title function_">on</span>(event.<span class="property">target</span>, <span class="string">&#x27;touchend&#x27;</span>, preventDefault, &#123; <span class="attr">passive</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">        target.<span class="property">current</span> = event.<span class="property">target</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 缓存定时器id</span></span><br><span class="line">      timeout.<span class="property">current</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">callback</span>(event), delay);</span><br><span class="line">    &#125;,</span><br><span class="line">    [callback, delay, isPreventDefault]</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装解除监听事件的函数</span></span><br><span class="line">  <span class="keyword">const</span> clear = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    timeout.<span class="property">current</span> &amp;&amp; <span class="built_in">clearTimeout</span>(timeout.<span class="property">current</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPreventDefault &amp;&amp; target.<span class="property">current</span>) &#123;</span><br><span class="line">      <span class="title function_">off</span>(target.<span class="property">current</span>, <span class="string">&#x27;touchend&#x27;</span>, preventDefault);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [isPreventDefault]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回的对象可以直接解构赋值给目标元素</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">onMouseDown</span>: <span class="function">(<span class="params">e: any</span>) =&gt;</span> <span class="title function_">start</span>(e),</span><br><span class="line">    <span class="attr">onTouchStart</span>: <span class="function">(<span class="params">e: any</span>) =&gt;</span> <span class="title function_">start</span>(e),</span><br><span class="line">    <span class="attr">onMouseUp</span>: clear,</span><br><span class="line">    <span class="attr">onMouseLeave</span>: clear,</span><br><span class="line">    <span class="attr">onTouchEnd</span>: clear,</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="keyword">const</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useLongPress;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用示例</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useLongPress &#125; <span class="keyword">from</span> <span class="string">&#x27;./useLongPress&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Demo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onLongPress</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;calls callback after long pressing 300ms&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">    <span class="attr">isPreventDefault</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">delay</span>: <span class="number">300</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> longPressEvent = <span class="title function_">useLongPress</span>(onLongPress, defaultOptions);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直接解构赋值给元素</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> &#123;<span class="attr">...longPressEvent</span>&#125;&gt;</span>useLongPress<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="useMeasure"><a href="#useMeasure" class="headerlink" title="useMeasure"></a>useMeasure</h2><p><code>useMeasure</code>用于测量一个DOM元素的尺寸和位置，并在尺寸或位置变化时更新这些信息。这个Hook依赖于<code>ResizeObserver API</code>，它允许你监听一个元素的大小变化。</p>
<blockquote>
<p><code>ResizeObserver</code>是一个强大的Web API，允许开发者监听HTML元素的尺寸变化。</p>
</blockquote>
<p><strong>基本用法</strong></p>
<p>使用<code>ResizeObserver</code>创建一个observer实例，并给它提供一个回调函数，该函数会在被观察元素的尺寸位置发生变化时被调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resizeObserver = <span class="keyword">new</span> <span class="title class_">ResizeObserver</span>(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> entry <span class="keyword">of</span> entries) &#123;</span><br><span class="line">    <span class="comment">// 从 entry.contentRect 中获取元素的尺寸位置信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123; width, height &#125; = entry.<span class="property">contentRect</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Element:&#x27;</span>, entry.<span class="property">target</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Element size: <span class="subst">$&#123;width&#125;</span>px x <span class="subst">$&#123;height&#125;</span>px`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设有一个元素是这样的：&lt;div id=&quot;myElement&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">const</span> myElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;myElement&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始观察myElement元素</span></span><br><span class="line">resizeObserver.<span class="title function_">observe</span>(myElement);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止观察某一个元素</span></span><br><span class="line">resizeObserver.<span class="title function_">unobserve</span>(myElement);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止观察所有元素并释放资源</span></span><br><span class="line">resizeObserver.<span class="title function_">disconnect</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useMemo, useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isBrowser, noop &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">UseMeasureRect</span> = <span class="title class_">Pick</span>&lt;</span><br><span class="line">  <span class="title class_">DOMRectReadOnly</span>,</span><br><span class="line">  <span class="string">&#x27;x&#x27;</span> | <span class="string">&#x27;y&#x27;</span> | <span class="string">&#x27;top&#x27;</span> | <span class="string">&#x27;left&#x27;</span> | <span class="string">&#x27;right&#x27;</span> | <span class="string">&#x27;bottom&#x27;</span> | <span class="string">&#x27;height&#x27;</span> | <span class="string">&#x27;width&#x27;</span></span><br><span class="line">&gt;;</span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">UseMeasureRef</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Element</span> = <span class="title class_">Element</span>&gt; = <span class="function">(<span class="params">element: E</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">UseMeasureResult</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Element</span> = <span class="title class_">Element</span>&gt; = [<span class="title class_">UseMeasureRef</span>&lt;E&gt;, <span class="title class_">UseMeasureRect</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义默认设置</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaultState</span>: <span class="title class_">UseMeasureRect</span> = &#123;</span><br><span class="line">  <span class="attr">x</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">y</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">top</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">left</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">bottom</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">right</span>: <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> useMeasure&lt;E <span class="keyword">extends</span> <span class="title class_">Element</span> = <span class="title class_">Element</span>&gt;(): <span class="title class_">UseMeasureResult</span>&lt;E&gt; &#123;</span><br><span class="line">  <span class="comment">// element用于存储对DOM元素的引用</span></span><br><span class="line">  <span class="keyword">const</span> [element, ref] = useState&lt;E | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// rect用于存储测量的结果</span></span><br><span class="line">  <span class="keyword">const</span> [rect, setRect] = useState&lt;<span class="title class_">UseMeasureRect</span>&gt;(defaultState);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个监听器函数，当被监听元素尺寸位置发生变化时，设置并返回新的位置尺寸信息</span></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="title function_">useMemo</span>(</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      <span class="keyword">new</span> (<span class="variable language_">window</span> <span class="keyword">as</span> any).<span class="title class_">ResizeObserver</span>(<span class="function">(<span class="params">entries</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entries[<span class="number">0</span>]) &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; x, y, width, height, top, left, bottom, right &#125; = entries[<span class="number">0</span>].<span class="property">contentRect</span>;</span><br><span class="line">          <span class="title function_">setRect</span>(&#123; x, y, width, height, top, left, bottom, right &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    []</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!element) <span class="keyword">return</span>;</span><br><span class="line">    observer.<span class="title function_">observe</span>(element);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      observer.<span class="title function_">disconnect</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [element]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回ref回调函数 可以将它绑定到元素的ref属性上，React会在组件挂载时将DOM元素作为参数传递给该ref回调函数</span></span><br><span class="line">  <span class="comment">// 以及 rect对象（包含了元素的尺寸和位置信息）</span></span><br><span class="line">  <span class="keyword">return</span> [ref, rect];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浏览器兼容性处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> isBrowser &amp;&amp; <span class="keyword">typeof</span> (<span class="variable language_">window</span> <span class="keyword">as</span> any).<span class="property">ResizeObserver</span> !== <span class="string">&#x27;undefined&#x27;</span></span><br><span class="line">  ? useMeasure</span><br><span class="line">  : ((<span class="function">() =&gt;</span> [noop, defaultState]) <span class="keyword">as</span> <span class="keyword">typeof</span> useMeasure);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="useMouse"><a href="#useMouse" class="headerlink" title="useMouse"></a>useMouse</h2><p><code>useMouse</code>用于动态跟踪鼠标的位置</p>
<p>源码及解析如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RefObject</span>, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> useRafState <span class="keyword">from</span> <span class="string">&#x27;./useRafState&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="attr">docX</span>: number; <span class="comment">// 鼠标的X坐标相对于整个文档（document）的位置</span></span><br><span class="line">  <span class="attr">docY</span>: number; <span class="comment">// 鼠标的Y坐标相对于整个文档的位置</span></span><br><span class="line">  <span class="attr">posX</span>: number; <span class="comment">// 目标元素的X坐标相对于其定位上下文（positioning context）的位置</span></span><br><span class="line">  <span class="attr">posY</span>: number; <span class="comment">// 目标元素的Y坐标相对于其定位上下文的位置</span></span><br><span class="line">  <span class="attr">elX</span>: number; <span class="comment">// 鼠标的X坐标相对于目标元素（offset parent）的位置</span></span><br><span class="line">  <span class="attr">elY</span>: number; <span class="comment">// 鼠标的Y坐标相对于目标元素（offset parent）的位置</span></span><br><span class="line">  <span class="attr">elH</span>: number; <span class="comment">// 目标元素自身的高度</span></span><br><span class="line">  <span class="attr">elW</span>: number; <span class="comment">// 目标元素自身的宽度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useMouse = (<span class="attr">ref</span>: <span class="title class_">RefObject</span>&lt;<span class="title class_">Element</span>&gt;): <span class="function"><span class="params">State</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useRafState&lt;<span class="title class_">State</span>&gt;(&#123;</span><br><span class="line">    <span class="attr">docX</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">docY</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">posX</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">posY</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">elX</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">elY</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">elH</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">elW</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">moveHandler</span> = (<span class="params">event: MouseEvent</span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 如果已经绑定了元素的ref属性</span></span><br><span class="line">      <span class="keyword">if</span> (ref &amp;&amp; ref.<span class="property">current</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; left, top, <span class="attr">width</span>: elW, <span class="attr">height</span>: elH &#125; = ref.<span class="property">current</span>.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">        <span class="comment">// window.pageXOffset 表示当前文档水平滚动的距离</span></span><br><span class="line">        <span class="keyword">const</span> posX = left + <span class="variable language_">window</span>.<span class="property">pageXOffset</span>;</span><br><span class="line">        <span class="keyword">const</span> posY = top + <span class="variable language_">window</span>.<span class="property">pageYOffset</span>;</span><br><span class="line">        <span class="keyword">const</span> elX = event.<span class="property">pageX</span> - posX;</span><br><span class="line">        <span class="keyword">const</span> elY = event.<span class="property">pageY</span> - posY;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">setState</span>(&#123;</span><br><span class="line">          <span class="attr">docX</span>: event.<span class="property">pageX</span>,</span><br><span class="line">          <span class="attr">docY</span>: event.<span class="property">pageY</span>,</span><br><span class="line">          posX,</span><br><span class="line">          posY,</span><br><span class="line">          elX,</span><br><span class="line">          elY,</span><br><span class="line">          elH,</span><br><span class="line">          elW,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">on</span>(<span class="variable language_">document</span>, <span class="string">&#x27;mousemove&#x27;</span>, moveHandler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">off</span>(<span class="variable language_">document</span>, <span class="string">&#x27;mousemove&#x27;</span>, moveHandler);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [ref]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useMouse;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="usePageLeave"><a href="#usePageLeave" class="headerlink" title="usePageLeave"></a>usePageLeave</h2><p><code>usePageLeave</code> 用于当鼠标离开页面时触发一个回调</p>
<blockquote>
<p><code>event.relatedTarget</code> 和 <code>event.toElement</code></p>
</blockquote>
<p>浏览器默认事件对象中的属性，<code>relatedTarget</code>属性是一个事件属性，它在某些特定的事件中提供了关于事件的额外上下文。这个属性特别用于鼠标事件，比如mouseover和mouseout，以及焦点事件，比如focusin和focusout。</p>
<p>relatedTarget属性引用了与事件相关的一个DOM元素</p>
<p>对于<strong>鼠标事件</strong>：</p>
<ul>
<li>在mouseover事件中，<code>relatedTarget</code>属性引用的是鼠标刚刚离开的那个元素，即鼠标指针之前所在的元素。</li>
<li>在mouseout事件中，<code>relatedTarget</code>属性引用的是鼠标即将移动到的那个元素，即鼠标指针即将进入的元素。</li>
</ul>
<p>对于<strong>焦点事件</strong>：</p>
<p>在focusin（或focus）事件中，<code>relatedTarget</code>属性引用的是失去焦点的元素，即焦点从哪个元素移开。<br>在focusout（或blur）事件中，<code>relatedTarget</code>属性引用的是即将获得焦点的元素，即焦点将要移到哪个元素上。</p>
<p><code>toElement</code>的作用与<code>relatedTarget</code>相似，特别是在mouseover和mouseout事件上，用于兼容旧版本浏览器</p>
<p>源码及解析如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">usePageLeave</span> = (<span class="params">onPageLeave, args = []</span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!onPageLeave) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">      event = event ? event : (<span class="variable language_">window</span>.<span class="property">event</span> <span class="keyword">as</span> any);</span><br><span class="line">      <span class="comment">// from 保存了鼠标即将移动到的元素</span></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">from</span> = event.<span class="property">relatedTarget</span> || event.<span class="property">toElement</span>;</span><br><span class="line">      <span class="comment">// 鼠标是否离开浏览器文档页面时触发回调</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">from</span> || (<span class="keyword">from</span> <span class="keyword">as</span> any).<span class="property">nodeName</span> === <span class="string">&#x27;HTML&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">onPageLeave</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">on</span>(<span class="variable language_">document</span>, <span class="string">&#x27;mouseout&#x27;</span>, handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">off</span>(<span class="variable language_">document</span>, <span class="string">&#x27;mouseout&#x27;</span>, handler);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, args);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> usePageLeave;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="useClickAway"><a href="#useClickAway" class="headerlink" title="useClickAway"></a>useClickAway</h2><p><code>useClickAway</code>用于当用户在目标元素外部单击时触发回调</p>
<p>源码及解析如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RefObject</span>, useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; off, on &#125; <span class="keyword">from</span> <span class="string">&#x27;./misc/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultEvents = [<span class="string">&#x27;mousedown&#x27;</span>, <span class="string">&#x27;touchstart&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ref：目标对象的ref引用</span></span><br><span class="line"><span class="comment"> * onClickAway：传入的回调函数</span></span><br><span class="line"><span class="comment"> * events：需要绑定的事件类型</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> useClickAway = &lt;E <span class="keyword">extends</span> <span class="title class_">Event</span> = <span class="title class_">Event</span>&gt;<span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  ref: RefObject&lt;HTMLElement | <span class="literal">null</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  onClickAway: (event: E) =&gt; <span class="keyword">void</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  events: string[] = defaultEvents</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 缓存传入的回调函数</span></span><br><span class="line">  <span class="keyword">const</span> savedCallback = <span class="title function_">useRef</span>(onClickAway);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    savedCallback.<span class="property">current</span> = onClickAway;</span><br><span class="line">  &#125;, [onClickAway]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">current</span>: el &#125; = ref;</span><br><span class="line">      <span class="comment">// el 是对DOM元素的引用</span></span><br><span class="line">      <span class="comment">// 如果 el存在 并且 当前触发事件的元素不是el及其子孙节点 则 执行传入的回调函数</span></span><br><span class="line">      <span class="comment">// contains 方法是用来测试一个节点是否是另一个节点的后代。如果目标元素在 el 之外，contains 方法会返回 false，取反后为 true</span></span><br><span class="line">      el &amp;&amp; !el.<span class="title function_">contains</span>(event.<span class="property">target</span>) &amp;&amp; savedCallback.<span class="title function_">current</span>(event);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 绑定用户传入的所有事件类型</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> eventName <span class="keyword">of</span> events) &#123;</span><br><span class="line">      <span class="title function_">on</span>(<span class="variable language_">document</span>, eventName, handler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> eventName <span class="keyword">of</span> events) &#123;</span><br><span class="line">        <span class="title function_">off</span>(<span class="variable language_">document</span>, eventName, handler);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [events, ref]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useClickAway;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/React-Hooks/">React Hooks</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 chen qiyi
    
  </p>
</footer>
    
    
  </div>
</div>
<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>